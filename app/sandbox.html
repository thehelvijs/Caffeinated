<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8" />
        <title>Casterlabs Caffeinated Sandbox</title>
        <script src="./js/invokable.js"></script>
        <script src="./js/event-handler.js"></script>
        <script>
            {
                const urlVars = (() => {
                    let vars = {};

                    window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, (m, key, value) => {
                        vars[key] = value;
                    });

                    return vars;
                })();

                const { frameId, consolePrefix, isDevEnviroment } = urlVars;

                const parentWindow = window.parent;
                const invokableHandler = (data) => {
                    parentWindow.postMessage(data, "*");
                };

                // Add a prefix to console.log
                {
                    const { info, log, warn, error, debug } = console;

                    for (const func of [info, log, warn, error, debug]) {
                        console[func.name] = function () {
                            func.apply(console, [
                                `[${consolePrefix}]`,
                                ...arguments
                            ]);
                        };
                    }
                }

                const invokable = new Invokable(invokableHandler, `${frameId}`);
                const caffeinatedWindowEventHandler = new EventHandler();

                // They get deregistered when you call document.open
                function addListeners() {
                    window.addEventListener("message", async (event) => {
                        console.debug(`[Module Sandbox, Outside -> (${frameId})]`, event.data);
                        await invokable.trigger(event.data);
                    });
                }

                addListeners();

                const PROXY = {
                    // Koi
                    koi_broadcast: null, // Set down below.

                    // Misc
                    ...invokable.funcs("emit"),
                    eval: eval,
                    loadDocumentContent: (contents) => {
                        try {
                            // This allows us to keep existing variables. :)
                            document.open();
                            document.write(contents);
                            document.close();
                        } catch (e) {
                            console.error(e);
                        }

                        addListeners();

                        PROXY.emit("document_content_load", {});
                    },
                };

                invokable.target = PROXY;

                // UNSAFE
                const UNSAFE = {
                    getModuleInfo: invokable.getFunc("unsafe_getModuleInfo"),
                    getSystemInfo: invokable.getFunc("unsafe_getSystemInfo")
                };

                window.UNSAFE = UNSAFE; // TEMP

                // CaffeinatedWindow
                {
                    const CaffeinatedWindow = {
                        reload: invokable.getFunc("caffeinatedWindow_reload"),
                        openLink: invokable.getFunc("caffeinatedWindow_openLink")
                    };

                    Object.freeze(CaffeinatedWindow);
                    Object.defineProperty(window, "CaffeinatedWindow", {
                        value: CaffeinatedWindow,
                        writable: false,
                        configurable: false
                    });
                }

                // Koi
                {
                    const listeners = {};

                    const koiEventHandler = new EventHandler();
                    let warnedDeprecated_addEventListener = false;

                    let viewerList = [];
                    let userData = null;
                    let streamData = null;

                    PROXY.koi_broadcast = koiEventHandler.broadcast;

                    const koi = {
                        sendChat: invokable.getFunc("koi_sendChat"),
                        getMaxLength: invokable.getFunc("koi_getMaxLength"),
                        isAlive: invokable.getFunc("koi_isAlive"),
                        upvote: invokable.getFunc("koi_upvote"),
                        deleteMessage: invokable.getFunc("koi_deleteMessage"),
                        test: invokable.getFunc("koi_test"),

                        ...koiEventHandler,

                        // Deprecated
                        addEventListener: function () {
                            if (!warnedDeprecated_addEventListener) {
                                warnedDeprecated_addEventListener = true;
                                console.warn("Calls to koi.addEventListener are deprecated. Tell the author of this plugin to use `koi.on` instead.");
                            }

                            koiEventHandler.on(...arguments);
                        },
                    };

                    koi.on("user_update", (event) => {
                        viewerList = event;
                    });
                    koi.on("user_update", (event) => {
                        userData = event;
                    });
                    koi.on("stream_status", (event) => {
                        streamData = event;
                    });

                    Object.defineProperty(koi, "viewerList", {
                        get: () => viewerList,
                        configurable: false
                    });
                    Object.defineProperty(koi, "userData", {
                        get: () => userData,
                        configurable: false
                    });
                    Object.defineProperty(koi, "streamData", {
                        get: () => streamData,
                        configurable: false
                    });

                    Object.freeze(koi);
                    Object.defineProperty(window, "Koi", {
                        value: koi,
                        writable: false,
                        configurable: false
                    });
                }

                // Caffeinated
                {
                    let systemInfo = null;

                    UNSAFE.getSystemInfo()
                        .then((info) => systemInfo = info);

                    const Caffeinated = {
                        // ...caffeinatedInvokable.funcs("getProductChannel", "triggerOneTimeBanner", "canTriggerOneTimeEvent"),

                        getTimeStreamedInMilliseconds() {
                            if (Koi.streamData.is_live) {
                                return Date.now() - new Date(Koi.streamData.start_time).getTime();
                            } else {
                                return 0;
                            }
                        }
                    };

                    Object.freeze(Caffeinated);
                    Object.defineProperty(window, "Caffeinated", {
                        value: Caffeinated,
                        writable: false,
                        configurable: false
                    });
                }

                // Module
                {
                    let moduleInfo = null;

                    UNSAFE.getModuleInfo()
                        .then((info) => moduleInfo = info);

                    const moduleEventHandler = new EventHandler();

                    const Module = {
                        ...moduleEventHandler,

                        get id() {
                            return moduleInfo.id;
                        },

                        get namespace() {
                            return moduleInfo.namespace;
                        },

                        get types() {
                            return moduleInfo.types;
                        }

                    };

                    Object.freeze(Module);
                    Object.defineProperty(window, "Module", {
                        value: Module,
                        writable: false,
                        configurable: false
                    });
                }

                // Isolate.
                for (const property of ["parent", "top", "frameElement", "require"]) {
                    try {
                        Object.defineProperty(window, property, {
                            value: undefined,
                            writable: false,
                            configurable: false
                        });
                    } catch (ignored) { }
                }

                // Finally signal that we're done.
                PROXY.emit("document_content_load", {});
            }
        </script>
    </head>

    <body>

    </body>

</html>