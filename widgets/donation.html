<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8" />
        <style>
            body {
                text-shadow: 1.5px 1.5px rgba(0, 0, 0, 0.3);
                padding: 0;
                margin: 0;
                width: 100vw;
                width: 100vmin;
            }

            #image,
            #video {
                display: block;
                margin-left: auto;
                margin-right: auto;
                object-fit: contain;
                height: 100%;
                width: 100%;
            }

            .draggable {
                overflow: hidden;
                position: absolute;
            }

            .container {
                left: 50%;
                top: 50%;
                width: 100vmin;
                height: 100vmin;
                transform: translate(-50%, -50%);
                position: absolute;
            }

            #alert-text {
                text-align: center;
            }

            .emote {
                object-fit: cover;
                height: 2ex;
                width: auto;
                display: inline-block;
                vertical-align: middle;
            }

            .hide {
                display: none !important;
            }
        </style>
        <title>Caffeinated Alert</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.0.2/anime.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/webfont/1.6.28/webfontloader.js"></script>
        <script src="overlayutil.js"></script>
        <script src="draggable.js"></script>
    </head>

    <body>
        <div class="container" style="opacity: 0;">
            <div id="alert-text" class="draggable"></div>
            <div id="alert-image" class="draggable">
                <img src="" id="image" class="hide" />
                <video src="" id="video" class="hide"></video>
            </div>
        </div>
    </body>

    <footer>
        <script>
            const overlay = new OverlayUtil("casterlabs_donation");

            const DISPLAY_TIME = 10 * 1000;
            const FADE_TIME = 1000;

            const eText = document.querySelector("#alert-text");
            const eImage = document.querySelector("#alert-image");
            const eContainer = document.querySelector(".container");

            const video = document.querySelector("#video");
            const img = document.querySelector("#image");

            let config = null;
            let files = {};
            let audio = {};
            let queue = [];

            const textDraggable = new Draggable(eText);
            const imageDraggable = new Draggable(eImage);

            function update(data) {
                config = data;

                overlay.changeFont(config.font);

                const sizeDelta = (config.font_size / 1000) * eContainer.offsetWidth;

                eText.style.color = config.text_color;
                eText.style.fontSize = `${sizeDelta}px`;

                updateDraggables();
            }

            function updateDraggables(draggable_positions = config.draggable_positions) {
                const { alert_text, alert_image } = draggable_positions;

                textDraggable.setSize(alert_text.width, alert_text.height);
                textDraggable.setPosition(alert_text.posX, alert_text.posY);
                textDraggable.setZ(alert_text.zIndex);

                imageDraggable.setSize(alert_image.width, alert_image.height);
                imageDraggable.setPosition(alert_image.posX, alert_image.posY);
                imageDraggable.setZ(alert_image.zIndex);
            }

            overlay.on("config", update);

            window.addEventListener("resize", () => {
                update(config);
            });

            overlay.on("draggable_update", (data) => {
                updateDraggables(data);
            });

            overlay.on("audio_file", (data) => {
                files.audio_file = data;
            });

            overlay.on("image_file", (data) => {
                files.image_file = data;
            });

            overlay.on("event", (html) => {
                if (config) {
                    queue.push(html);

                    if (queue.length == 1) {
                        render();
                    }
                }
            });

            async function render() {
                let displayTime = DISPLAY_TIME;
                const event = queue[0];

                video.classList = "hide";
                img.classList = "hide";

                switch (config.image) {
                    case "Custom Image": {
                        if (!files.image_file) {
                            break;
                        } else if (files.image_file.startsWith("data:video")) {
                            video.src = files.image_file;
                            video.play();
                            video.classList = "";
                            video.addEventListener("loadeddata", () => {
                                const duration = video.duration * 1000;
                                displayTime += (duration - DISPLAY_TIME);
                            });
                        } else {
                            img.classList = "";
                            img.src = files.image_file;
                        }
                        break;
                    }

                    case "Donation Image": {
                        img.src = event.image;
                        img.classList = "";
                        break;
                    }

                    case "Animated Donation Image": {
                        img.src = event.animated_image;
                        img.classList = "";
                        break;
                    }

                    default: break;
                }

                const originalMessage = event.message;

                event.message = escapeHtml(event.message);

                for (const [name, image] of Object.entries(event.emotes)) {
                    event.message = event.message.split(name).join(`<img class="emote" title="${name}" src="${image}" />`);
                }

                eText.innerHTML = `<span style="color: ${event.sender.color};">${event.sender.displayname}</span><br /><span>${event.message}</span>`;

                switch (config.audio) {
                    case "Custom Audio": {
                        playAudio();
                        break;
                    }

                    case "Custom Audio & Text To Speech": {
                        playAudio().then(() => playTTS(originalMessage));
                        break;
                    }

                    case "Text To Speech": {
                        playTTS(originalMessage);
                        break;
                    }

                    case "None": break;
                }

                displayTime -= (FADE_TIME * 2); // So it stops perfectly

                anime({
                    targets: ".container",
                    easing: "linear",
                    opacity: 1,
                    duration: FADE_TIME
                }).finished.then(async function () {
                    await sleep(displayTime);

                    anime({
                        targets: ".container",
                        easing: "linear",
                        opacity: 0,
                        duration: FADE_TIME
                    }).finished.then(function () {
                        queue.shift();

                        if (queue.length > 0) {
                            render();
                        }
                    });
                });
            }

            function playAudio() {
                try {
                    audio = new Audio(files.audio_file);

                    audio.volume = config.volume;
                    audio.play();
                } catch (e) {
                    audio = {};
                }
            }

            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

        </script>
    </footer>

</html>